# auto_distance_calibration
auto_distance_calibration是探维科技TensorPro系列产品的自动化距离标定软件，在Windows10 64位环境(Python支持库numpy)下开发测试通过，此版本目前供公司内部测试。使用者可在本文件定义类的基础上继续编程。

# 软件功能介绍

本程序包括四个子程序：

1. com_test.py用于测试激光测距仪能否正常工作。包括确定激光测距仪在测试电脑上占据的com端口号，以及获得单次测距结果两个功能。

    - 查询端口号功能利用python自带的serial.tools.list_ports.comports()指令，将与测试电脑连接的所有COM口打印出来。只要在测试时保证只有激光测距仪一个设备连接至电脑即可，此时打印出的唯一端口号即为激光测距仪端口号。
    
    - 单次测距功能利用ModBus协议向测距仪发送连续测距指令，清空寄存器缓存后发送读出指令。此时将寄存器中存储的测距值（byte数据）读出，并换算为实际的测距值打印在解释器中。

2. auto_measure_beta.py用于驱动自动化测试工站进行标定数据采集。
    
    程序利用ModBus协议和激光测距仪以及小车电机进行通信，利用网口和雷达进行通信，可以实现驱动小车的运动，控制测距仪测距以及采集雷达UDP包的功能。
    
    - 其中小车的运动间隔通过控制前进指令和停止指令之间的时间间隔来实现。常规模式指令间隔为0.2秒，小车运动间隔约为10厘米。小间隔模式指令间隔为0，实际间隔为ModBus协议的极限相应速度，运动间隔约为6厘米。
    - 测距仪测距及UDP包采集在小车停止运动指令发出1.5秒后开始，为了保证小车此时已经处于稳定静止状态。

    下边描述一下测量过程的程序逻辑，我们将测量过程分为测量过程和返回过程两个阶段：

    测量阶段：

    - 程序开始运行后，将首先利用测距仪测量当前位置距墙面的距离，并采集1700个UDP包数据（20帧），将其中水平角度在91°和89°之间的各通道数据保存在以当前测距值命名的txt文档中。

    - 如果当前距离大于减速阈值（通过slow_limit变量设置，目前程序中设置为0.4米），小车将以常规模式向前运动。当运动停止后将完成测距和UDP包采集过程。然后根据新的测距值进行下一次判断。

    - 如果距离大于下限阈值（通过down_limit变量设置，目前程序中设置为0.12米）而小于减速阈值（通过slow_limit变量设置，目前程序中设置为0.4米），小车将切换到小间隔模式向前运动。当运动停止后将完成测距和UDP包采集过程。然后根据新的测距值进行下一次判断。

    - 如果距离小于下限阈值，小车将不会继续向前移动，而切换到返回阶段开始后退。   

    返回阶段：

    - 当完成最后一次数据采集后，程序将控制小车电机反向，并驱动小车向反向运动。
    - 在返回过程中激光测距仪将持续测量到墙面的距离。当此距离大于设定的停止距离（通过init_distance变量设置，目前程序设置为7.1米）小车将停止运动，数据采集过程结束。此时小车将停止在接近开始测试的位置，方便进行下一次标定测试。

3. calibration_flash.py可利用auto_measure_beta.py采集的原始数据生成距离修正查找表。该查找表可用于FPGA版本7.4.11的机器，查找表下载到flash中，不带有校验位功能。

    - 对于每个原始数据文件，程序将16个通道的所有有效测距值收集起来（测距值大于0小于10米，脉宽值大于0小于8米），滤除其中偏差大于三倍标准差的点后，计算剩余数据的平均值。这样对于每一个数据文件都会得到一个测距真值（来自激光测距仪）和16个通道在此距离下的测距平均值。

    - 在完成所有数据的统计后，利用上述数据绘制测距线性图及残差图。线性图横坐标为各个位置的测距真值，纵坐标为每个通道的实际测距值，共16张图，展示每一个通道的测距变化。残差图横坐标为每个通道的实测值序列，纵坐标为该实测值与测距真值的残差。其中测距真值的通过测距仪测距值除以相应通道与水平线夹角的余弦值得到。

    - 自动寻找非单调点功能：
        - 程序通过blind参数设置默认盲区（目前设置默认盲区为0.3米）。在确定修正范围下限时，程序将首先设置为每个通道在激光测距为0.3米处的雷达测距值。
        - 独立盲区：如果某些通道需要设置与其他通道不一样的盲区，可以通过设置leftbound参数实现。leftbound为一维数组，共有十六个元素，默认值均为0，分别代表1~16通道。将想修改的通道对应位置的0改为想设置的盲区即可。
        - 如果开启自动寻找非单调点功能，程序将自动寻找各通道出现非单调点的位置。如果非单调点位置大于默认盲区位置（0.3米），程序将自动将该通道修正下限推远到盲区之外。
   
    - 距离修正查找表的数据格式如下：每个通道包含2048个数据，前六个数据表示查找表覆盖的测距范围，以count为单位。后面的2042行表示对应的距离修正值，同样以count为单位。

        下边举例说明，当获得一个测距值，其对应的测距修正值的查找方法如下：
      - 某通道修正表前三行的数据分别为N0，N1,N2。分别将这三个数用二进制形式表示，即N0=ABCD,N1=EFGH,N2=IJKL。这些字母均代表0或1。
      - 将ABCDEF拼接为一个二进制数，并将其转换为十进制数NL，该数字代表修正范围下限。将将GHIJKL拼接为一个二进制数，并将其转换为十进制数NH，该数字代表修正范围上限。
      - 测距的count值为N
      - 如果N小于NL，则测距值强制置为0；如果N大于NH，责令N=NH
      - 对应的修正数据行数应为“N-NL+7”
      - 4到6行为异常上限功能，目前数据处理过程未开启此功能，查找表中该三行数据置0。
4.  calibration_flash_check.py与calibration_flash.py的功能及使用方法完全相同。唯一的区别是生成的查找表带有校验位功能，可以用于7.5.0及之后的所有FPGA版本。
# 软件下载

1. 下载代码

```bash
git clone https://github.com/tanwayRD/auto_distance_calibration.git
```

输入用户名密码，下载成功后，所在git工作目录下就会出现程序包。此步骤也可直接在github的项目下直接下载程序的zip压缩包，然后解压到所需文件夹下。

# 软件使用

1. com_test.py的使用：利用pycharm软件打开程序脚本，点击运行，会有窗口弹出。

    - 获得com端口号：点击弹窗中的‘获取COM端口号’按钮。程序会打印出激光测距仪使用的com号。测试前将得到的com号填入配置文件中即可。

    - 单次测距：将function值设为1，在点击弹窗中的‘获取COM端口号’按钮后，点击测距按钮，程序会打印出激光测距仪与墙面之间的距离值。

2. auto_measure_beta.py的使用

    - 开始测试前，将小车拉倒距离墙面最远处。修改配置文件config.txt中的相关内容，端口号值设为正确的数值，将想要保存原始数据的路径填入save_path。配置文件中相关片段如下：
    ```text
    COM = 8
    save_path = D:/Work/tanway/9_2/pro_0816/calibration_wop 
    ```
    - 点击运行程序，程序会弹出窗口。首先加载修改后的配置文件，再点击弹窗上的运行按钮，系统将自动完成测试，小车会回到起始位置。测试完成pycharm窗口会输出Finish字样。此时在数据保存路径下将得到一系列以测距值命名的txt格式原始文件。

3. calibration_flash.py的使用

    - 修改配置文件config.txt中的相关内容，将function值设为1，开启自动寻找非单调点功能（0为关闭此功能），确认默认盲区范围（blind数值）符合客户要求（默认为0.3米）。如有必要，修改相应通道的自定义盲区范围，该通道盲区范围将由此自定义值替代默认值。如不需要设置填0即可。
    - 点击运行程序，程序会弹出窗口。首先选择原始数据所在文件夹位置，再加载修改后的配置文件。点击弹窗中的运行按钮，等待程序运行完毕即可。程序运行完毕pycharm窗口会输出Finish字样，此时在数据路径下会生成output文件夹，里面包含线性图，残差图以及查找表文件。配置文件相关片段如下：

```text
function = 1
blind = 0.3
channel_1 = 0
channel_2 = 0
channel_3 = 0
channel_4 = 0
channel_5 = 0
channel_6 = 0
channel_7 = 0
channel_8 = 0
channel_9 = 0
channel_10 = 0
channel_11 = 0
channel_12 = 0
channel_13 = 0
channel_14 = 0
channel_15 = 0
channel_16 = 0
```
4. calibration_flash_check.py的使用与calibration_flash.py的使用完全相同。# Scope-RangeCalibration
